# VSCode Encrypted ZIP 拡張機能アーキテクチャ

## 全体アーキテクチャ図

```
┌─────────────────────────────────────────────────────────────────────────┐
│                     VSCode Encrypted ZIP Extension                       │
└───────────────────────────────────┬─────────────────────────────────────┘
                                    │
┌───────────────────────────────────▼─────────────────────────────────────┐
│                      Extension Activation (activate)                     │
│                                                                          │
│  ┌────────────────────────────┐   ┌────────────────────────────────┐    │
│  │    Register ZIP Format     │   │   Register Commands & Event    │    │
│  │  archiver-zip-encrypted    │   │        Handlers               │    │
│  └────────────────────────────┘   └────────────────────────────────┘    │
└───────────────────────────────────┬─────────────────────────────────────┘
                                    │
┌───────────────────────────────────▼─────────────────────────────────────┐
│                         Command Entry Points                            │
│                                                                          │
│  ┌────────────────────────┐ ┌─────────────────────┐ ┌────────────────┐  │
│  │createEncryptedZip      │ │createFromActiveFile │ │createFromDrag  │  │
│  │(Explorer Context Menu) │ │(Editor Context Menu)│ │(Keyboard)      │  │
│  └───────────┬────────────┘ └──────────┬──────────┘ └───────┬────────┘  │
│              │                         │                    │           │
│              └─────────────────────────┼────────────────────┘           │
│                                        │                                │
└───────────────────────────────────────┬┴────────────────────────────────┘
                                        │
┌───────────────────────────────────────▼─────────────────────────────────┐
│                        Core createEncryptedZip                          │
│                                                                          │
│  ┌────────────────────────┐ ┌─────────────────────┐ ┌────────────────┐  │
│  │   Password Pattern     │ │Password Generation  │ │Clipboard Copy  │  │
│  │   Selection UI        │ │ & Pattern Selection │ │                │  │
│  └───────────┬────────────┘ └──────────┬──────────┘ └───────┬────────┘  │
│              │                         │                    │           │
│              └─────────────────────────┼────────────────────┘           │
│                                        │                                │
└───────────────────────────────────────┬┴────────────────────────────────┘
                                        │
┌───────────────────────────────────────▼─────────────────────────────────┐
│                           File Handling Process                         │
│                                                                          │
│  ┌────────────────────────┐ ┌─────────────────────┐ ┌────────────────┐  │
│  │  Save Location Dialog  │ │  ZIP Archive        │ │Progress Display│  │
│  │                        │ │  Creation           │ │                │  │
│  └────────────────────────┘ └─────────────────────┘ └────────────────┘  │
└─────────────────────────────────────────────────────────────────────────┘

┌─────────────────────────────────────────────────────────────────────────┐
│                       Configuration Management                          │
│                                                                          │
│  ┌────────────────────────────┐   ┌────────────────────────────────┐    │
│  │    Password Patterns       │   │   Default Pattern Settings     │    │
│  │    Management             │   │                                │    │
│  └────────────────────────────┘   └────────────────────────────────┘    │
└─────────────────────────────────────────────────────────────────────────┘

┌─────────────────────────────────────────────────────────────────────────┐
│                         External Dependencies                           │
│                                                                          │
│  ┌────────────────────────┐ ┌─────────────────────┐ ┌────────────────┐  │
│  │    VS Code API         │ │    archiver         │ │   crypto       │  │
│  │                        │ │                     │ │                │  │
│  └────────────────────────┘ └─────────────────────┘ └────────────────┘  │
└─────────────────────────────────────────────────────────────────────────┘
```

## コンポーネント説明

### 1. 拡張機能アクティベーション
- `activate` 関数: VS Code 起動時に呼び出される
- ZIP フォーマットの登録: `archiver.registerFormat('zip-encrypted', archiverZipEncrypted)`
- コマンド登録: 各コマンドとそのハンドラを VS Code に登録

### 2. コマンドエントリーポイント
- `vscode-encrypted-zip.createEncryptedZip`: エクスプローラのコンテキストメニューから
- `vscode-encrypted-zip.createFromActiveFile`: エディタのコンテキストメニューから
- `vscode-encrypted-zip.createFromDragDrop`: キーボードショートカットまたはコマンドパレットから
- `vscode-encrypted-zip.configurePasswordPatterns`: パスワードパターン設定へのアクセス

### 3. 暗号化ZIPコア機能
- `generateRandomPassword`: パスワードパターンに基づいて安全なパスワードを生成
- パスワードパターン選択UI: `vscode.window.showQuickPick` によるパターン選択
- クリップボード連携: 生成されたパスワードの自動コピー (`vscode.env.clipboard.writeText`)

### 4. ファイル処理プロセス
- 保存先選択: `vscode.window.showSaveDialog` による保存先の選択
- ZIP アーカイブ作成: `archiver` ライブラリによる暗号化 ZIP の作成
- 進捗表示: `vscode.window.withProgress` による処理進行状況の表示

### 5. 設定管理
- `encryptedZip.passwordPatterns`: パスワードパターン定義の配列
- `encryptedZip.defaultPasswordPattern`: デフォルトで使用するパターンのインデックス

### 6. 外部依存関係
- VS Code API: UI インタラクションとプラットフォーム統合
- archiver: ZIP ファイル作成のコアエンジン
- archiver-zip-encrypted: ZIP 暗号化のプラグイン
- crypto: 暗号学的に安全なランダムパスワード生成

## データフロー

1. ユーザーがコンテキストメニューまたはショートカットで拡張機能を起動
2. 選択されたファイル/フォルダのパスが取得される
3. パスワードパターン選択または自分でパスワードを入力
4. 選択されたパターンに基づきパスワードが生成され、クリップボードにコピー
5. 保存先が選択される
6. 進捗表示と共に ZIP ファイルが作成される
7. 処理完了の通知が表示される

## 設計パターン

- **コマンドパターン**: VS Code の拡張機能フレームワークに沿ったコマンド登録と実行
- **ファクトリーパターン**: パスワード生成処理でのパターンに基づく生成
- **オブザーバーパターン**: 進捗状況の監視と表示

## テスト構造

- 単体テスト: `パスワード生成のテスト`, `パスワードパターンのテスト`
- 統合テスト: `ファイル選択テスト`, `ファイル名生成テスト`
- エンドツーエンドテスト: コンテキストメニュー項目のテスト

## 将来の拡張性

- 追加の暗号化方式のサポート
- カスタムUI要素の改善
- バッチ処理機能
- 圧縮レベルのカスタマイズ